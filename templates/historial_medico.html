{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    
    <div class="card shadow-sm mb-4 border-0 bg-light">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-primary mb-0">
                    <i class="bi bi-person-circle"></i> 
                    {{ paciente.usuario.last_name }} {{ paciente.usuario.first_name }}
                </h2>
                <div class="text-muted mt-1">
                    <span class="me-3"><i class="bi bi-card-heading"></i> C.I: {{ paciente.usuario.cedula }}</span>
                    <span class="me-3"><i class="bi bi-droplet-half"></i> Sangre: {{ paciente.tipo_sangre }}</span>
                    <span><i class="bi bi-cake"></i> Edad: {{ paciente.fecha_nacimiento|timesince }}</span>
                </div>
            </div>
            <div>
                <a href="{% url 'crear_historia' paciente.id %}" class="btn btn-primary btn-lg shadow">
                    <i class="bi bi-plus-lg"></i> Nueva Consulta
                </a>
            </div>
        </div>
    </div>

    <h4 class="mb-3 text-secondary border-bottom pb-2">
        <i class="bi bi-journal-medical"></i> Historial de Atenciones
    </h4>

    <div class="accordion" id="accordionHistorial">
        
        {% for h in historias %}
        <div class="accordion-item shadow-sm mb-2 border">
            
            <h2 class="accordion-header" id="heading{{ h.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ h.id }}" aria-expanded="false" aria-controls="collapse{{ h.id }}">
                    <div class="d-flex w-100 justify-content-between align-items-center pe-3">
                        <div>
                            <strong>{{ h.fecha_atencion|date:"d/M/Y" }}</strong> 
                            <small class="text-muted ms-2">{{ h.fecha_atencion|date:"H:i" }}</small>
                        </div>
                        <div class="text-uppercase text-truncate ms-3 me-auto" style="max-width: 500px;">
                            {{ h.diagnostico }}
                        </div>
                        <span class="badge bg-info text-dark">Dr. {{ h.medico.usuario.last_name }}</span>
                    </div>
                </button>
            </h2>

            <div id="collapse{{ h.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ h.id }}" data-bs-parent="#accordionHistorial">
                <div class="accordion-body bg-white">
                    
                    <div class="row text-center mb-3 bg-light p-2 rounded mx-1">
                        <div class="col"><small class="text-muted">Temp</small><br><strong>{{ h.temperatura|default:"--" }} °C</strong></div>
                        <div class="col"><small class="text-muted">Presión</small><br><strong>{{ h.presion_arterial|default:"--" }}</strong></div>
                        <div class="col"><small class="text-muted">Pulso</small><br><strong>{{ h.pulso|default:"--" }} ppm</strong></div>
                        <div class="col"><small class="text-muted">Peso</small><br><strong>{{ h.peso|default:"--" }} Kg</strong></div>
                        <div class="col"><small class="text-muted">Talla</small><br><strong>{{ h.altura|default:"--" }} m</strong></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Motivo y Enfermedad Actual</h6>
                            <p class="small text-muted mb-1">Motivo:</p>
                            <p>{{ h.motivo_consulta }}</p>
                            <p class="small text-muted mb-1">Enfermedad Actual:</p>
                            <p>{{ h.enfermedad_actual }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Examen Físico y Diagnóstico</h6>
                            <p class="small text-muted mb-1">Examen Físico:</p>
                            <p>{{ h.examen_fisico }}</p>
                            <p class="small text-muted mb-1">Diagnóstico (CIE-10):</p>
                            <p class="fw-bold">{{ h.diagnostico }}</p>
                        </div>
                    </div>

                    {% if h.oftalmologia %}
                    <div class="card border-info mt-3 mb-3">
                        <div class="card-header bg-info text-white py-1">
                            <small><i class="bi bi-eye-fill"></i> DATOS OFTALMOLÓGICOS</small>
                        </div>
                        <div class="card-body bg-light">
                            <div class="row text-center">
                                <div class="col-md-6 border-end">
                                    <h6 class="text-primary fw-bold">OJO DERECHO</h6>
                                    <p class="mb-1">AV: <strong>{{ h.oftalmologia.agudeza_visual_od }}</strong></p>
                                    <p class="mb-0">PIO: <strong>{{ h.oftalmologia.presion_intraocular_od }} mmHg</strong></p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary fw-bold">OJO IZQUIERDO</h6>
                                    <p class="mb-1">AV: <strong>{{ h.oftalmologia.agudeza_visual_oi }}</strong></p>
                                    <p class="mb-0">PIO: <strong>{{ h.oftalmologia.presion_intraocular_oi }} mmHg</strong></p>
                                </div>
                            </div>
                            {% if h.oftalmologia.fondo_ojo %}
                                <hr>
                                <p class="mb-0"><small class="fw-bold">Fondo de Ojo / Notas:</small><br> {{ h.oftalmologia.fondo_ojo }}</p>
                            {% endif %}
                            {% if h.pediatria %}
                            <div class="card border-warning mt-3 mb-3">
                                <div class="card-header bg-warning text-dark py-1">
                                    <small><i class="bi bi-emoji-smile"></i> DATOS PEDIÁTRICOS</small>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="row text-center">
                                        <div class="col"><small>Parto:</small><br><strong>{{ h.pediatria.tipo_parto }}</strong></div>
                                        <div class="col"><small>Lactancia:</small><br><strong>{{ h.pediatria.lactancia }}</strong></div>
                                        <div class="col"><small>Peso Nacer:</small><br><strong>{{ h.pediatria.peso_nacimiento }}</strong></div>
                                        <div class="col">
                                            <small>Vacunas:</small><br>
                                            {% if h.pediatria.vacunas_completas %}
                                                <span class="badge bg-success">Completas</span>
                                            {% else %}
                                                <span class="badge bg-danger">Pendientes</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if h.pediatria.observaciones_crecimiento %}
                                        <hr class="my-2">
                                        <p class="mb-0 small"><strong>Desarrollo:</strong> {{ h.pediatria.observaciones_crecimiento }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            {% if h.ginecologia %}
                            <div class="card border-danger mt-3 mb-3">
                                <div class="card-header bg-danger text-white py-1">
                                    <small><i class="bi bi-gender-female"></i> DATOS GINECO-OBSTÉTRICOS</small>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="row align-items-center">
                                        <div class="col-md-4 border-end">
                                            <h6 class="text-danger mb-0">FUM: {{ h.ginecologia.fum|default:"No registrada" }}</h6>
                                            <small class="text-muted">{{ h.ginecologia.ciclo_menstrual }}</small>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="d-flex justify-content-around fw-bold text-secondary">
                                                <span>G: {{ h.ginecologia.gestas }}</span>
                                                <span>P: {{ h.ginecologia.partos }}</span>
                                                <span>C: {{ h.ginecologia.cesareas }}</span>
                                                <span>A: {{ h.ginecologia.abortos }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% if h.ginecologia.anticonceptivos %}
                                        <hr class="my-2">
                                        <p class="mb-0 small"><strong>Anticoncepción:</strong> {{ h.ginecologia.anticonceptivos }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            {% if h.cardiologia %}
                            <div class="card border-danger mt-3 mb-3">
                                <div class="card-header bg-danger text-white py-1">
                                    <small><i class="bi bi-heart-pulse"></i> DATOS CARDIOLÓGICOS</small>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="row text-center mb-2">
                                        <div class="col border-end">RIESGO: <strong>{{ h.cardiologia.riesgo }}</strong></div>
                                        <div class="col">CLASE: <strong>{{ h.cardiologia.clase_funcional }}</strong></div>
                                    </div>
                                    <p class="small mb-1"><strong>EKG:</strong> {{ h.cardiologia.electrocardiograma }}</p>
                                    <p class="small mb-0"><strong>ECO:</strong> {{ h.cardiologia.ecocardiograma }}</p>
                                </div>
                            </div>
                            {% endif %}

                            {% if h.dermatologia %}
                            <div class="card border-primary mt-3 mb-3">
                                <div class="card-header bg-primary text-white py-1">
                                    <small><i class="bi bi-person-bounding-box"></i> DATOS DERMATOLÓGICOS</small>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="d-flex justify-content-between">
                                        <span><strong>Fototipo:</strong> {{ h.dermatologia.fototipo }}</span>
                                        <span><strong>Biopsia:</strong> 
                                            {% if h.dermatologia.biopsia %} <span class="badge bg-danger">SÍ</span> {% else %} NO {% endif %}
                                        </span>
                                    </div>
                                    <hr class="my-2">
                                    <p class="mb-1"><strong>Lesión:</strong> {{ h.dermatologia.lesion_primaria }}</p>
                                    <p class="mb-0 small text-muted">{{ h.dermatologia.localizacion }} - {{ h.dermatologia.distribucion }}</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if h.odontologia %}
                    <div class="card border-secondary mt-3 mb-3">
                        <div class="card-header bg-secondary text-white py-1">
                            <small><i class="bi bi-mouth"></i> DATOS ODONTOLÓGICOS</small>
                        </div>
                        <div class="card-body bg-light">
                            <div class="row text-center mb-2">
                                <div class="col border-end">HIGIENE: <strong>{{ h.odontologia.get_higiene_oral_display }}</strong></div>
                                <div class="col">ENCÍAS: <strong>{{ h.odontologia.get_encias_display }}</strong></div>
                            </div>
                            {% if h.odontologia.dientes_tratados %}
                                <p class="mb-1"><strong>Piezas Tratadas:</strong> {{ h.odontologia.dientes_tratados }}</p>
                            {% endif %}
                            <hr class="my-2">
                            <p class="mb-0"><strong>Procedimiento:</strong> {{ h.odontologia.procedimiento }}</p>
                            {% if h.odontologia.proxima_cita %}
                                <div class="alert alert-warning mt-2 py-1 px-2 text-center">
                                    <small><i class="bi bi-calendar-event"></i> Próxima cita sugerida: <strong>{{ h.odontologia.proxima_cita|date:"d/M/Y" }}</strong></small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if h.psicologia %}
                    <div class="card mt-3 mb-3" style="border-color: #6f42c1;">
                        <div class="card-header text-white py-1" style="background-color: #6f42c1;">
                            <small><i class="bi bi-brain"></i> SALUD MENTAL</small>
                        </div>
                        <div class="card-body bg-light">
                            <p class="mb-1"><strong>Estado de Ánimo:</strong> {{ h.psicologia.estado_animo }}</p>
                            <p class="mb-1"><strong>Sueño/Apetito:</strong> {{ h.psicologia.sueno_apetito }}</p>
                            <hr class="my-2">
                            <p class="small mb-1 text-muted">Apariencia:</p>
                            <p class="mb-2">{{ h.psicologia.apariencia_comportamiento }}</p>
                            <div class="alert alert-light border mt-2">
                                <strong>Plan Terapéutico:</strong> {{ h.psicologia.plan_sesiones }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if h.nutricion %}
                    <div class="card border-success mt-3 mb-3">
                        <div class="card-header bg-success text-white py-1">
                            <small><i class="bi bi-apple"></i> DATOS NUTRICIONALES</small>
                        </div>
                        <div class="card-body bg-light">
                            <div class="row text-center mb-2">
                                <div class="col border-end">IMC: <strong>{{ h.nutricion.imc }}</strong></div>
                                <div class="col border-end">Grasa: <strong>{{ h.nutricion.grasa_corporal }}</strong></div>
                                <div class="col">Músculo: <strong>{{ h.nutricion.masa_muscular }}</strong></div>
                            </div>
                            <div class="row text-center mb-2 small text-muted">
                                <div class="col">Cintura: {{ h.nutricion.circunferencia_cintura }} cm</div>
                                <div class="col">Cadera: {{ h.nutricion.circunferencia_cadera }} cm</div>
                            </div>
                            <hr class="my-2">
                            <p class="mb-0"><strong>Plan Alimenticio:</strong> {{ h.nutricion.tipo_dieta }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if h.otorrino %}
                    <div class="card border-dark mt-3 mb-3">
                        <div class="card-header bg-dark text-white py-1">
                            <small><i class="bi bi-ear"></i> EXAMEN ORL</small>
                        </div>
                        <div class="card-body bg-light">
                            <div class="row">
                                <div class="col-md-6 border-end">
                                    <p class="mb-1 small"><strong>Oído Der:</strong> {{ h.otorrino.otoscopia_od }}</p>
                                    <p class="mb-1 small"><strong>Oído Izq:</strong> {{ h.otorrino.otoscopia_oi }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1 small"><strong>Nariz:</strong> Tabique {{ h.otorrino.get_tabique_display }}</p>
                                    <p class="mb-1 small"><strong>Garganta:</strong> {{ h.otorrino.orofaringe }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if h.traumatologia %}
                    <div class="card border-dark mt-3 mb-3">
                        <div class="card-header bg-dark text-white py-1">
                            <small><i class="bi bi-bandaid"></i> EVALUACIÓN ORTOPÉDICA</small>
                        </div>
                        <div class="card-body bg-light">
                            <h6 class="text-uppercase fw-bold">{{ h.traumatologia.zona_afectada }}</h6>
                            <p class="small text-muted mb-2">Mecanismo: {{ h.traumatologia.mecanismo_lesion }}</p>
                            
                            <div class="row text-center border-top border-bottom py-2 mb-2 bg-white">
                                <div class="col border-end">Movilidad: <strong>{{ h.traumatologia.movilidad }}</strong></div>
                                <div class="col">Fuerza: <strong>{{ h.traumatologia.fuerza_muscular }}</strong></div>
                            </div>
                            
                            {% if h.traumatologia.pruebas_especiales %}
                                <p class="mb-1"><strong>Pruebas:</strong> {{ h.traumatologia.pruebas_especiales }}</p>
                            {% endif %}
                            
                            {% if h.traumatologia.plan_rehabilitacion %}
                                <div class="alert alert-secondary mt-2 py-1">
                                    <strong>Plan Rehab:</strong> {{ h.traumatologia.plan_rehabilitacion }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-success mt-2">
                        <strong><i class="bi bi-capsule"></i> Tratamiento / Receta:</strong><br>
                        {{ h.tratamiento|linebreaks }}
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-3">
                        
                        <div class="d-flex flex-wrap gap-2">
                            {% if h.imagenes.all %}
                                {% for img in h.imagenes.all %}
                                    <a href="{{ img.archivo.url }}" target="_blank">
                                        <img src="{{ img.archivo.url }}" class="img-thumbnail" style="height: 80px; width: 80px; object-fit: cover;">
                                    </a>
                                {% endfor %}
                            {% else %}
                                <small class="text-muted">Sin imágenes adjuntas.</small>
                            {% endif %}
                        </div>

                        <div>
                            <a href="{% url 'imprimir_receta' h.id %}" target="_blank" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-file-earmark-pdf-fill"></i> Receta PDF
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        {% empty %}
            <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-circle"></i> No hay historias registradas para este paciente.
            </div>
        {% endfor %}

    </div>

    <div class="mt-4">
        <a href="{% url 'listar_pacientes' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Listado
        </a>
    </div>
</div>
{% endblock %}